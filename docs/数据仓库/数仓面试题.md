# 数仓面试题

## 数仓理论

### 数据库 VS 数据仓库

**数据库：**

数据库是面向业务的处理系统，主要针对业务在数据库的操作性处理，也被称为**联机事务处理 OLTP**，通常对记录进行查询、更新。

**数据仓库：**

数据仓库是面向主题的、集成的、非易失的且随时间变化的**数据集合**。数据仓库一般**针对某些主题的历史数据进行分析**、支持管理决策，又被称为**联机分析处理 OLAP**。

!!! note "区别"

    - 数据库是面向事务的设计，数据仓库是面向主题设计的。
    - 数据库一般存储业务数据，数据仓库存储的一般是历史数据。
    - 数据库设计是尽量避免冗余，常采用符合范式规范来设计。数据仓库设计关注数据整合、分析、处理性能，有意引入冗余，采用反范式设计。
    - 数据库主要操作是随机读写，数据仓库是为分析数据而设计，主要操作是批量读写。

---

### 数据仓库的四个特点

- **面向主题的**：数据仓库的数据是按照主题进行组织的，每个主题都能反应具体的业务需求，以电商数仓为例，常见主题有用户、商品、商户、交易、营销等。
- **集成的**：数据仓库中的数据从多个数据源中汇集，经过清洗、转换、统一而来的。
- **非易失的**：数据仓库中的数据以大量的查询为主，修改和删除的操作很少，只需要定期加载、更新即可。
- **随时间变化的**：数据仓库中的数据是反应历史变化的，包含从过去某一时间点至今的数据。

---

### 为什么需要建设数据仓库

- **维护历史数据**，可以基于历史数据进行分析，为企业提供决策支持。
- **减轻业务数据库的存储和计算压力**。
- 将多个数据源的数据进行整合，能够提供一个**统一的数据视图**，方便分析。
- 能够将多个数据源的数据进行**清洗、转换、统一**，**提高数据质量**。
- 基于分布式系统，能够提供**海量数据的存储能力以及高性能的计算能力**。
- 利用分层架构，能够**快速查询大量经整合的数据**，并减少重复的开发过程。

---

### 常见的数据仓库架构

**Inmon 架构：**

Inmon 架构的思想在于**自上而下地构建数据模型**。Bill Inmon 的方法强调更加集中、全面和结构化的数据仓库环境。 它**提倡标准化的数据模型**，其中数据被组织到单独的表中，以**消除冗余并保持数据完整性**。**其核心思想在于数仓分层**。

它使用“数据仓库总线”的概念来创建标准化、可重用的组件，并强调数据集成、转换和治理，以确保数据的准确性和一致性。换言之就是，尽量将某一主题域的所有数据都考虑到数据建模中。这样设计的数据模型的覆盖面会更广，但是数据模型的设计会更困难。

![](https://raw.githubusercontent.com/MXJULY/image/main/img/202312281718960.png)

**Kimball 架构：**

Kimball 架构的思想在于**自下而上地构建数据模型**。以具体业务需求为出发点，设计数据模型，**其核心思想在于维度建模**。（即根据业务需求找到关注的数据指标，基于关注的数据指标设计数据模型，这样设计的数据模型会更加的独立，但可能会导致数据模型过多发展）

Ralph Kimball 以其维度建模方法而闻名，该方法**专注于以针对最终用户查询和报告优化的方式提供数据**。 Kimball 方法侧重于使用星型模式结构创建数据仓库，其中中央事实表保存定量度量，维度表描述相关属性。 它是一种自上而下、迭代且敏捷的方法，强调通过构建特定于主题的数据集市来满足特定用户报告需求来快速交付业务价值。

![](https://raw.githubusercontent.com/MXJULY/image/main/img/202312281727600.png)

!!! note

    目前企业的数据仓库设计一般都是综合了两者的实现，整体上采用分层架构，具体的模型设计上采用维度建模。

**数据集市架构：**

数据集市是**按主题域组织的数据集合**，用于支持部门级的决策。

![](https://raw.githubusercontent.com/MXJULY/image/main/img/202312281729247.png)

**混合型数据仓库架构：**

所谓的混合型结构，指的是在一个数据仓库环境中，联合使用 Inmon 和 Kimball 两种架构。

这种架构将 Inmon 方法中的数据集市部分替换成了一个多维数据仓库，而数据集市则是多维数据仓库上的逻辑视图。

使用这种架构的好处是，既可以利用规范化设计消除数据冗余，保证数据的粒度足够细，又可以利用多维结构更灵活地在企业级实现报表和分析。

![](https://raw.githubusercontent.com/MXJULY/image/main/img/202312281730852.png)

---

### Kimball 数据仓库架构包括哪些模块

- **操作型系统/数据源**：包括各种数据源，如业务数据库、日志文件、外部数据等。
- **数据过渡区**：包括数据清洗、数据转换、数据集成等。
- **数据仓库**：维度建模，以星型模型或是雪花模型等方式构建维度数据仓库。
- **用户接口**：包括即席查询、报表、可视化、数据挖掘等。

---

### 对比 Inmon 和 Kimball 架构

**Inmon 架构：**

Inmon 架构的思想在于**自上而下地构建数据模型**，从数据源到数据仓库再到数据集市。**强调标准化的数据模型**，使用范式建模以**消除冗余并保持数据完整性**。**其核心思想在于数仓分层**。

其中的数据建模分为三个层次：高层模型、中间层模型、底层模型。

- ERD（实体关系图）是最顶层的概念模型，是实体关系的高度抽象，主要用于确定各个实体（或主题）及其之间的关系
- 中间层是数据集成（DIS），用于对主要数据分组，设置数据的链接，确定主键、属性和关系
- 底层是物理模型，用于设计关系表，在这一层上，确定数据的粒度、对数据进行分区、定义引用、创建索引等

**Kimball 架构：**

Kimball 架构的思想在于**自下而上地构建数据模型**，从数据源到数据集市再到数据仓库。根据业务需求找到关注的数据指标，再基于关注的数据指标设计数据模型。**其核心思想在于维度建模**，以星型模型或是雪花模型等方式构建维度数据仓库。

| Inmon 架构                                                                               | Kimball 架构                                                                         |
| :--------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------- |
| Inmon 架构由于采用了范式建模，所以数据模型的设计更加的规范，但是数据模型的设计会更困难。 | Kimball 架构由于采用了维度建模，所以数据模型的设计更加的灵活，但是维护的成本会更高。 |

---

### 介绍一下常见的数据模型

**关系数据模型/范式模型：**

关系数据模型是一种**二维表格模型**，它将数据组织成**行和列**的形式，每一行称为一个记录，每一列称为一个字段，每个字段只有一个值，每个记录都是唯一的。

关系数据模型的设计遵循一定的规范，即**范式**，范式分为六种，分别是第一范式（1NF）、第二范式（2NF）、第三范式（3NF）、巴斯-科德范式（BCNF）、第四范式（4NF）、第五范式（5NF）。

**维度数据模型：**

按照事实表和维度表进行构建数仓和数据集市，以星型模型和雪花模型为主。切换不同维度的查询时非常的方便，有良好的扩展性能。

**Data Vault 模型：**

中心辐射式，中心表记录主键，链接表记录业务关系，附属表记录业务描述。

---

### 介绍一下三范式

!!! note "1NF"

    **确保表中的每列是原子、不可再分的。**

!!! note "2NF"

    在满足 1NF 的情况下，**不能存在部分依赖。**即非主键字段必须**完全依赖**于主键，而不能依赖于主键的一部分。

考虑一个订单明细表：`OrderDetail(OrderID，ProductID，UnitPrice，Discount，Quantity，ProductName)`。

因为我们知道在一个订单中可以订购多种产品，所以单单一个 OrderID 是不足以成为主键的，主键应该是 `(OrderID，ProductID)`。显而易见 `Discount` 和 `Quantity` 完全依赖于主键 `(OrderID，ProductID)`，而 `UnitPrice` 和 `ProductName` 只依赖于 `ProductID`。所以 OrderDetail 表不符合 2NF。不符合 2NF 的设计容易产生冗余数据。

可以把 OrderDetail 表拆分为 `OrderDetail(OrderID，ProductID，Discount，Quantity)` 和 `Product(ProductID，UnitPrice，ProductName)` 来消除原订单表中 `UnitPrice` 和 `ProductName` 多次重复的情况。

!!! note "3NF"

    在满足 2NF 的情况下，**不能存在传递依赖。** 3NF 是对字段冗余性的约束，要求任何字段不能由其他字段派生出来，它要求字段没有冗余，即不存在传递依赖。

考虑一个订单表 `Order(OrderID，OrderDate，CustomerID，CustomerName，CustomerAddr，CustomerCity)` 主键是 `(OrderID)`。

其中 `OrderDate, CustomerID, CustomerName, CustomerAddr, CustomerCity` 等非主键列都完全依赖于主键 `(OrderID)`，所以符合 2NF。不过问题是 `CustomerName, CustomerAddr, CustomerCity` 直接依赖的是 `CustomerID`（非主键列），而不是直接依赖于主键，它是通过传递才依赖于主键，所以不符合 3NF。

通过拆分 Order 为 `Order(OrderID，OrderDate，CustomerID)` 和 `Customer(CustomerID，CustomerName，CustomerAddr，CustomerCity)` 从而达到 3NF。

**第二范式（2NF）和第三范式（3NF）的概念很容易混淆，区分它们的关键点在于，2NF：非主键列是否完全依赖于主键，还是依赖于主键的一部分；3NF：非主键列是直接依赖于主键，还是直接依赖于非主键列。**

!!! note "反范式化"

    降低范式就是增加字段，允许冗余，达到以空间换时间的目的。

没有冗余的数据库设计可以做到。但是，没有冗余的数据库未必是最好的数据库，有时为了提高运行效率，就必须降低范式标准，适当保留冗余数据。

如订单表，“金额”这个字段的存在，表明该表的设计不满足第三范式，因为“金额”可以由“单价”乘以“数量”得到，说明“金额”是冗余字段。但是，增加“金额”这个冗余字段，可以提高查询统计的速度，这就是以空间换时间的作法。

---

### 列举一下你使用过的反范式化设计，并说明理由

- 逆 1NF：hive 里面的 map 结构
- 逆 2NF：log 日志表，做 PV、UV
- 逆 3NF：宽表设计

---

### 介绍一下星型模型、雪花模型和星座模型

**星型模型：**

**星型模式由事实表和维度表组成，一个星型模式中可以有一个或多个事实表，每个事实表引用任意数量的维表。**

![](https://raw.githubusercontent.com/MXJULY/image/main/img/202312281918072.png)

星型模式是**反范式化(denormalized)**的，**优点**是设计和实现起来比较简单，查询性能也比较高（join 的数量较少）。但是，星型模式的**缺点**是数据存储空间较大；而且，由于是非规范化的，数据的更新操作会更困难。星型模式的另一个缺点是对于分析需求来说不够灵活。它更偏重于为特定目的建造数据视图，因此实际上很难进行全面的数据分析。

**雪花模型：**

雪花模型是星型模型的扩展，**雪花模型是在星型模型的基础上，将维度表进一步范式化(normalized)**，即将维度表中的某些字段单独成表，这些字段和维度表的主键构成主外键关系。

![](https://raw.githubusercontent.com/MXJULY/image/main/img/202312281919853.png)

雪花模型的特点是**维度表的规范化程度更高**，因此**减少了数据冗余、节省了存储空间**，但是不可避免地增加了表的数量，因此**查询性能会有所下降**。

**星型 VS 雪花模型**

| 属性           | 星型模型 | 雪花模型           |
| :------------- | :------- | :----------------- |
| 数据总量       | 多       | 少                 |
| 可读性         | 高       | 低                 |
| 表个数         | 少       | 多                 |
| 查询速度       | 高       | 低                 |
| 数据冗余       | 多       | 少                 |
| 对事实表的情况 | 增加宽度 | 字段比较少，冗余低 |
| 拓展性         | 差       | 好                 |

**星型模型因为数据的冗余所以很多统计查询不需要做外部的连接，因此一般情况下效率比雪花型模型要高**。星型结构不用考虑很多范式化的因素，设计与实现都比较简单。

雪花型模型由于去除了冗余，有些统计就需要通过表的联接才能产生，所以效率不一定有星型模型高。范式化也是一种比较复杂的过程，相应的数据库结构设计、数据的 ETL、以及后期的维护都要复杂一些。**因此在冗余可以接受的前提下，实际运用中星型模型使用更多，也更有效率**。

**星座模型：**

星座模型是星型模型和雪花模型的混合体，**星座模型是在星型模型的基础上，多个事实表共享维度表**。

![](https://raw.githubusercontent.com/MXJULY/image/main/img/202312281933541.png)

---

### 介绍一下几种事实表并说明应用场景

1. **事务事实表**：记录的事务层面的事实，保存的是最原子的数据，也称“原子事实表”。事务事实表中的数据在事务事件发生后产生，数据的粒度通常是每个事务记录一条记录。

2. **周期快照事实表**：以具有规律性的、可预见的时间间隔来记录事实，时间间隔如每天、每月、每年等等。典型的例子如销售日快照表、库存日快照表等。它统计的是间隔周期内的度量统计，如历史至今、自然年至今、季度至今等等。

3. **累积快照事实表**：记录的不确定的周期的数据。累积快照事实表代表的是完全覆盖一个事务或产品的生命周期的时间跨度，它通常具有多个日期字段，用来记录整个生命周期中的关键时间点。例如订单累计快照事实表会有付款日期，发货日期，收货日期等时间点，还有数量、金额、运费这些事实字段。

---
