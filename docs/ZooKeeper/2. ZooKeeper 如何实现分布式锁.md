# ZooKeeper 如何实现分布式锁

分布式锁是控制分布式系统之间同步访问共享资源的一种方式。如果不同的系统或是同一个系统的不同主机之间共享了一个或一组资源，那么访问这些资源的时候，往往需要通过一些互斥手段来防止彼此之间的干扰，以保证一致性。在这种情况下，就需要使用分布式锁。

## 排他锁

排他锁（Exclusive Lock，简称 X 锁），又称为写锁或独占锁。如果事务 $T_1$ 对数据对象 $O_1$ 加上了排他锁，那么在整个加锁期间，只允许事务 $T_1$ 对 $O_1$ 进行读取和更新操作，其他任何事务都不能再对 $O_1$ 进行任何类型的操作，直到锁被释放。

排他锁的核心是如何保证当前有且仅有一个事务获得锁，并且锁被释放后，所有正在等待获取锁的事务都能够得到通知。

### 定义锁

**ZooKeeper 上的一个数据节点表示一个锁**，例如：`/exclusive_lock/lock` 节点就可以被定义为一个锁。

![](https://raw.githubusercontent.com/MXJULY/image/main/img/202307241939203.png)

### 获取锁

在需要获取排他锁时，所有的客户端都会试图通过调用 `create()` 接口，在 `/exclusive_lock` 节点下创建**临时子节点** `/exclusive_lock/lock` 。**由于 ZooKeeper 的强一致性，在所有的客户端中，最终只有一个客户端能够创建成功，那么就认为该客户端获取了锁。**

### 释放锁

由于 `/exclusive_lock/lock` 是一个临时节点，因此在以下情况下，都有可能释放锁：

- 当前获取锁的客户端宕机，那么 ZooKeeper 上的这个临时节点被移除
- 正常执行完业务逻辑，客户端就会主动将自己创建的临时节点删除

**无论在什么情况下移除了 lock 节点，ZooKeeper 都会通知所有在 `/exclusive_lock` 节点上注册了子节点变更 Watcher 监听的客户端**。这些客户端在接收到通知后，再次重新发起分布式锁获取。

## 共享锁

共享锁（Shared Lock，简称 S 锁），又称为读锁。如果事务 $T_1$ 对数据对象 $O_1$ 加上了共享锁，那么当前事务只能对 $O_1$ 进行读取操作，其他事务也只能对这个数据对象加共享锁。

**共享锁和排他锁最根本的区别在于，加上排他锁后，数据对象只对一个事务可见，而加共享锁后，数据对所有事务可见。**

### 定义锁

和排他锁一样，同样是通过 ZooKeeper 上的数据节点来表示一个锁，是一个类似于 `/shared_lock/[Hostname]-请求类型-序号` 的**临时顺序节点**。

![](https://raw.githubusercontent.com/MXJULY/image/main/img/202307241939208.png)

### 获取锁

在需要获取共享锁时，所有客户端都会到 `/shared_lock` 这个节点下面创建一个临时顺序节点。

### 判断读写顺序

根据共享锁的定义，**不同的事务都可以同时对同一个数据对象进行读取操作，而写操作必须在当前没有任何事物进行读写操作的情况下进行**。

如何确定分布式读写顺序：

第一步：创建完节点后，获取 `/shared_lock` 节点下的所有子节点，并对该节点注册子节点变更的 Watcher 监听

第二步：确定自己的节点序号在所有子节点中的顺序

第三步：

对于读请求：

- 如果没有比自己序号小的子节点，或是所有比自己序号小的子节点都是读请求，那么表明自己已经成功获取到了共享锁，同时开始执行读取逻辑。
- 如果比自己序号小的子节点中有写请求，那么就需要进入等待。

对于写请求：

- 如果自己不是序号最小的子节点，那么就需要进入等待。

第四步：收到 Watcher 通知后，重复第一步。

### 释放锁

和排他锁释放锁的逻辑一致。

## 羊群效应

以上的共享锁实现，能满足一般的分布式集群竞争锁的需求，并且性能还不错。但是如果机器规模扩大之后可能会产生一些问题。

当一个客户端移除了自己的共享锁后，ZooKeeper 会把子节点变更 Watcher 通知发送给所有监听的机器，然而这个通知事实上只对下一个节点对应的客户端产生了实际的影响，对余下的所有机器都没有任何作用。**客户端无端地接收到过多和自己并不相关的事件通知。**

**改进方案：每个节点对应的客户端只需要关注比自己序号小的那个相关节点的变更情况即可，不需要关注全局的子列表变更情况。**

这里的「比自己序号小的相关节点」对于读请求和写请求不一样：

- 读请求：向比自己序号小的最后一个写请求节点注册 Watcher 监听
- 写请求：向比自己序号小的最后一个节点注册 Watcher 监听
